{% extends "base.html" %}
{% block title %}AcademicPro - Home{% endblock %}
{% block content %}
<section class="home-hero text-center py-5">
  <h1 class="display-5 fw-bold">Explore AcademicPro - Trusted Academic Support</h1>
  <p class="lead text-muted">Discover expert writing services, free learning resources, and a secure academic workflow.</p>
  <div class="d-flex justify-content-center gap-2 flex-wrap">
    {% if current_user.is_authenticated and current_user.is_admin %}
    <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-primary btn-lg">Open Admin Dashboard</a>
    <a href="{{ url_for('main.admin_orders') }}" class="btn btn-warning btn-lg">Monitor Orders</a>
    <a href="{{ url_for('main.public_blogs') }}" class="btn btn-outline-primary btn-lg">Resource Hub</a>
    {% elif current_user.is_authenticated and writer_enabled %}
    <a href="{{ url_for('main.jobs') }}" class="btn btn-primary btn-lg">Open Job Board</a>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-warning btn-lg">Writer Dashboard</a>
    <a href="{{ url_for('main.public_blogs') }}" class="btn btn-outline-primary btn-lg">Resource Hub</a>
    {% elif current_user.is_authenticated %}
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary btn-lg">Open Dashboard</a>
    <a href="{{ url_for('main.order') }}" class="btn btn-warning btn-lg">Place Order</a>
    <a href="{{ url_for('main.public_blogs') }}" class="btn btn-outline-primary btn-lg">Resource Hub</a>
    {% else %}
    <a href="{{ url_for('main.register') }}" class="btn btn-primary btn-lg">Sign Up</a>
    <a href="{{ url_for('main.order') }}" class="btn btn-warning btn-lg">Place Order</a>
    <a href="{{ url_for('main.writer_apply') }}" class="btn btn-outline-primary btn-lg">Apply as Writer</a>
    {% endif %}
  </div>
</section>

<section class="mb-5">
  <div class="row g-3 text-center">
    <div class="col-md-3"><div class="tile-soft"><div class="metric-value">1200+</div><div class="metric-label">Students Supported</div></div></div>
    <div class="col-md-3"><div class="tile-soft"><div class="metric-value">3500</div><div class="metric-label">Papers Delivered</div></div></div>
    <div class="col-md-3"><div class="tile-soft"><div class="metric-value">96%</div><div class="metric-label">On-Time Success</div></div></div>
    <div class="col-md-3"><div class="tile-soft text-start small"><div>✔ SSL Secure Portal</div><div>✔ Free Similarity Report Included</div><div>✔ Confidentiality Guaranteed</div></div></div>
  </div>
</section>

<section class="mb-5">
  <h2 class="section-title text-center">Trust & Transparency</h2>
  <div class="row g-3">
    <div class="col-md-4"><div class="tile-soft h-100"><h5>Plagiarism Report Included</h5><p class="mb-0">Every completed order includes a similarity report summary for transparency and quality assurance.</p></div></div>
    <div class="col-md-4"><div class="tile-soft h-100"><h5>Money-Back & Revision Policy</h5><p class="mb-2">Clear terms for refunds and revisions reduce client risk.</p><a href="{{ url_for('main.payment_policy') }}">View policy</a></div></div>
    <div class="col-md-4"><div class="tile-soft h-100"><h5>Professional Standards</h5><p class="mb-0">Our internal quality process follows academic integrity, formatting accuracy, and deadline discipline.</p></div></div>
  </div>
</section>

<section class="home-structured-block mb-5">
  <div class="home-structured-shell">
    <h2 class="section-title text-center mb-2">How It Works</h2>
    <p class="text-center text-muted mb-4">A transparent process designed for secure delivery and clear communication.</p>
    <div class="how-timeline">
      <article class="how-step-card">
        <div class="how-step-icon"><i class="bi bi-file-earmark-text"></i></div>
        <h5>Submit Instructions</h5>
        <p>Share your topic, academic level, citation style, and deadline with full requirements.</p>
        <div class="small text-muted">Clear briefs lead to faster, stronger drafts.</div>
      </article>
      <article class="how-step-card">
        <div class="how-step-icon"><i class="bi bi-shield-check"></i></div>
        <h5>Admin Review</h5>
        <p>Every order is checked and matched to a qualified writer by subject expertise.</p>
        <div class="small text-muted">Quality and fit are verified before work starts.</div>
      </article>
      <article class="how-step-card">
        <div class="how-step-icon"><i class="bi bi-lock"></i></div>
        <h5>Secure Deposit</h5>
        <p>Payment is held under platform rules while your task progresses.</p>
        <div class="small text-muted">Safe escrow-style handling protects both sides.</div>
      </article>
      <article class="how-step-card">
        <div class="how-step-icon"><i class="bi bi-chat-dots"></i></div>
        <h5>Live Collaboration</h5>
        <p>Use built-in chat to clarify details, review updates, and guide the outcome.</p>
        <div class="small text-muted">Everything stays in one organized workspace.</div>
      </article>
      <article class="how-step-card">
        <div class="how-step-icon"><i class="bi bi-check-circle"></i></div>
        <h5>Review & Release</h5>
        <p>Approve the final paper or request revision before payment is released.</p>
        <div class="small text-muted">Completion is controlled by your satisfaction.</div>
      </article>
    </div>
  </div>
</section>

<section class="home-structured-block home-structured-block-alt mb-5" id="services">
  <div class="home-structured-shell">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <h2 class="section-title mb-0">Our Services</h2>
      <a href="{{ url_for('main.services_page') }}" class="btn btn-outline-primary">Explore All Services</a>
    </div>
    <div class="row g-3">
      <div class="col-md-6 col-lg-3">
        <div class="service-card h-100">
          <div class="service-icon"><i class="bi bi-journal-text"></i></div>
          <h5>Essay Writing</h5>
          <p>Narrative, persuasive, and analytical essays tailored to your academic level and rubric.</p>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="service-card h-100">
          <div class="service-icon"><i class="bi bi-bar-chart-line"></i></div>
          <h5>Research Papers</h5>
          <p>Evidence-based papers with credible sources, proper citations, and plagiarism-free originality.</p>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="service-card h-100">
          <div class="service-icon"><i class="bi bi-mortarboard"></i></div>
          <h5>Dissertations</h5>
          <p>Comprehensive support from proposal design and methodology to final review and defense prep.</p>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="service-card h-100">
          <div class="service-icon"><i class="bi bi-check2-square"></i></div>
          <h5>Assignments</h5>
          <p>Reliable help for coursework, problem-solving tasks, and case studies across disciplines.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="home-structured-block mb-5" id="writers">
  <div class="home-structured-shell">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <h2 class="section-title mb-0">Meet Our Writers</h2>
      <a href="{{ url_for('main.public_writers') }}" class="btn btn-primary">View Writers</a>
    </div>
    <div class="row g-3">
      {% if writers %}
        {% for w in writers %}
          {% set safe_rating = w.rating if w.rating and w.rating > 0 else 4.8 %}
          {% set safe_reviews = review_counts.get(w.id, 0) if review_counts.get(w.id, 0) > 0 else 25 %}
          <div class="col-md-6 col-lg-4">
            <div class="writer-profile-card h-100">
              <div class="writer-profile-head">
                <img src="{{ url_for('static', filename='img/writer-photo.png') }}" alt="{{ w.name }} profile" class="writer-profile-avatar">
                <div>
                  <h5 class="mb-0">{{ w.name }}</h5>
                  <div class="small text-muted">{{ w.subject or 'Academic Specialist' }}</div>
                </div>
              </div>
              <div class="writer-rating-line">
                <span class="stars">★★★★☆</span>
                <span class="small">{{ '%.1f'|format(safe_rating) }}/5</span>
                <span class="small text-muted">({{ safe_reviews }} reviews)</span>
              </div>
              <p class="mb-3">Trusted for clear structure, accurate referencing, and dependable on-time delivery.</p>
              <a href="{{ url_for('main.public_writers') }}" class="btn btn-outline-primary btn-sm">View Full Profile</a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col-12"><div class="tile-soft">No approved writers yet.</div></div>
      {% endif %}
    </div>
  </div>
</section>

<section class="writer-recruit-band mb-5" id="writer-recruitment">
  <div class="writer-recruit-shell">
    <div class="row g-4 align-items-stretch">
      <div class="col-lg-6">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-mortarboard-fill"></i>
          <h2 class="mb-0">{{ recruitment.headline }}</h2>
        </div>
        <p class="mb-3">{{ recruitment.subtext }}</p>
        <div class="writer-recruit-benefits mb-3">
          <div class="benefit-row"><i class="bi bi-clock-history"></i><span>{{ recruitment.benefits[0] if recruitment.benefits|length > 0 else 'Flexible work schedule' }}</span></div>
          <div class="benefit-row"><i class="bi bi-shield-check"></i><span>{{ recruitment.benefits[1] if recruitment.benefits|length > 1 else 'Secure payments' }}</span></div>
          <div class="benefit-row"><i class="bi bi-journal-bookmark"></i><span>{{ recruitment.benefits[2] if recruitment.benefits|length > 2 else 'Build your academic portfolio' }}</span></div>
          <div class="benefit-row"><i class="bi bi-globe2"></i><span>{{ recruitment.benefits[3] if recruitment.benefits|length > 3 else 'Work with global clients' }}</span></div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <a href="{{ url_for('main.writer_apply') }}" class="btn writer-recruit-btn btn-lg">{{ recruitment.cta_text }}</a>
          <a href="{{ url_for('main.writer_recruitment') }}" class="btn writer-learn-btn btn-lg">Learn More About Becoming a Writer</a>
        </div>

        <blockquote class="writer-quote mt-3 mb-0">"{{ recruitment.testimonial }}" - {{ recruitment.testimonial_author }}</blockquote>
      </div>
      <div class="col-lg-6">
        <div class="writer-recruit-right h-100">
          <div class="writer-visual-stage mb-3" aria-label="Writer recruitment visual">
            <div class="writer-visual-overlay">
              <div class="writer-visual-title">Writer Pathway</div>
              <div class="writer-visual-sub">Structured onboarding for quality and consistency</div>
              <div class="writer-visual-steps">
                {% for step in recruitment.steps[:4] %}
                <span class="visual-step">{{ loop.index }}. {{ step }}</span>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="writer-recruit-card writer-spotlight-card">
            <h5 class="mb-2">Writer Spotlight</h5>
            {% if writers %}
            {% set sw = writers[0] %}
            <div class="d-flex align-items-center gap-2">
              <img src="{{ url_for('static', filename='img/writer-photo.png') }}" alt="Writer spotlight" class="writer-spotlight-avatar">
              <div>
                <div class="fw-semibold">{{ sw.name }}</div>
                <div class="small text-muted">{{ sw.subject or 'Academic Specialist' }}</div>
                <div class="small">Rating: {{ sw.rating or 4.8 }}/5</div>
              </div>
            </div>
            {% else %}
            <div class="small text-muted">Approved writer spotlights will appear here.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="home-structured-block mb-5" id="testimonials">
  <div class="home-structured-shell">
    <h2 class="section-title mb-2">Testimonials</h2>
    <p class="text-muted mb-4">Real feedback from students who used AcademicPro to meet tight deadlines with confidence.</p>
    <div class="row g-3">
      <div class="col-md-6">
        <article class="testimonial-card h-100">
          <div class="testimonial-quote-mark"><i class="bi bi-quote"></i></div>
          <p class="mb-3">"AcademicPro helped me meet my deadline and improve my grade. The process was smooth and professional."</p>
          <div class="d-flex align-items-center gap-2">
            <span class="testimonial-avatar">S</span>
            <div>
              <div class="fw-semibold">Sarah</div>
              <div class="small text-muted">University Student</div>
            </div>
          </div>
        </article>
      </div>
      <div class="col-md-6">
        <article class="testimonial-card h-100">
          <div class="testimonial-quote-mark"><i class="bi bi-quote"></i></div>
          <p class="mb-3">"I was impressed by the quality of research and the attention to detail. Highly recommended!"</p>
          <div class="d-flex align-items-center gap-2">
            <span class="testimonial-avatar">D</span>
            <div>
              <div class="fw-semibold">Daniel</div>
              <div class="small text-muted">Graduate Student</div>
            </div>
          </div>
        </article>
      </div>
    </div>
  </div>
</section>

<section class="home-structured-block home-structured-block-alt mb-5">
  <div class="home-structured-shell">
    <h2 class="section-title mb-2">Student Success Stories</h2>
    <p class="text-muted mb-4">Selected examples showing how structured support turned high-pressure tasks into strong submissions.</p>
    <div class="row g-3">
      <div class="col-md-6">
        <article class="success-story-card h-100">
          <div class="success-story-icon"><i class="bi bi-heart-pulse"></i></div>
          <h5>Dissertation Rescue (Nursing)</h5>
          <p class="mb-1"><span class="fw-semibold">Challenge:</span> Weak methodology chapter and deadline pressure.</p>
          <p class="mb-0"><span class="fw-semibold">Outcome:</span> Revised structure, evidence-backed data interpretation, and on-time submission with supervisor approval.</p>
        </article>
      </div>
      <div class="col-md-6">
        <article class="success-story-card h-100">
          <div class="success-story-icon"><i class="bi bi-graph-up-arrow"></i></div>
          <h5>Data Analysis Support (Business)</h5>
          <p class="mb-1"><span class="fw-semibold">Challenge:</span> Complex dataset and unclear narrative.</p>
          <p class="mb-0"><span class="fw-semibold">Outcome:</span> Clear analysis framework, visualized findings, and stronger argument quality for final grading.</p>
        </article>
      </div>
    </div>
  </div>
</section>

<section class="mb-5">
  <h2 class="section-title text-center">Accreditation & Quality Badges</h2>
  <div class="d-flex flex-wrap justify-content-center gap-3">
    <span class="badge bg-light text-dark border p-2">Academic Integrity Standard</span>
    <span class="badge bg-light text-dark border p-2">Secure Payments Verified</span>
    <span class="badge bg-light text-dark border p-2">Confidential Workflow Certified</span>
  </div>
</section>

<section class="mb-5" id="blog">
  <h2 class="section-title">Blog / Resources</h2>
  <ul class="list-group">
    <li class="list-group-item"><a href="{{ url_for('main.public_blogs') }}?q=thesis statement">How to Write a Strong Thesis Statement</a></li>
    <li class="list-group-item"><a href="{{ url_for('main.public_blogs') }}?q=study hacks">Top 5 Study Hacks for Busy Students</a></li>
    <li class="list-group-item"><a href="{{ url_for('main.public_blogs') }}?q=plagiarism">Avoiding Plagiarism: A Student’s Guide</a></li>
  </ul>
</section>

<section class="cta-band text-center py-4 mb-3">
  <h2 class="h3 fw-bold">Ready to Ace Your Papers?</h2>
  <p class="mb-3">Get started today with expert academic support.</p>
  <a href="{{ url_for('main.order') }}" class="btn btn-warning btn-lg">Place Order</a>
</section>

<div class="guest-float-stack" aria-label="Guest support tools">
  {% if not current_user.is_authenticated %}
  <button id="guestMsgFab" class="guest-fab msg" type="button" title="Message Admin" aria-label="Message admin">💬</button>
  {% endif %}
</div>

{% if not current_user.is_authenticated %}
<div id="guestMsgPanel" class="guest-panel d-none" role="dialog" aria-label="Guest message panel">
  <div class="guest-panel-head">
    <strong>Message Admin</strong>
    <button type="button" class="btn-close btn-close-sm" data-close="guestMsgPanel" aria-label="Close"></button>
  </div>
  <div class="guest-panel-body">
    <div id="guestMsgThread" class="mb-2"></div>
    <div class="small text-muted mb-2">For follow-up, include your email.</div>
    <div class="mb-2">
      <input id="guestMsgEmail" class="form-control form-control-sm" placeholder="Email (optional)">
    </div>
    <div class="mb-2">
      <textarea id="guestMsgInput" rows="4" class="form-control form-control-sm" placeholder="Type your message..." required></textarea>
    </div>
    <div id="guestMsgStatus" class="small text-muted"></div>
  </div>
  <div class="guest-panel-foot">
    <button id="guestMsgSendBtn" class="btn btn-primary btn-sm w-100" type="button">Send Message</button>
  </div>
</div>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="guestWelcomeToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Welcome to AcademicPro</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      We noticed you are visiting as a guest. Create an account to access full order tracking, writer chat, and advanced features.
      <div class="mt-2 d-flex gap-2">
        <a class="btn btn-sm btn-primary" href="{{ url_for('main.register') }}">Create Account</a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.login') }}">Sign In</a>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const msgFab = document.getElementById("guestMsgFab");
    const msgPanel = document.getElementById("guestMsgPanel");

    function togglePanel(panel) {
      panel.classList.toggle("d-none");
    }

    if (msgFab && msgPanel) msgFab.addEventListener("click", function () { togglePanel(msgPanel); });

    document.querySelectorAll("[data-close]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        const id = btn.getAttribute("data-close");
        const panel = document.getElementById(id);
        if (panel) panel.classList.add("d-none");
        if (id === "guestMsgPanel" && guestMsgPollTimer) {
          clearInterval(guestMsgPollTimer);
          guestMsgPollTimer = null;
        }
      });
    });

    const sendBtn = document.getElementById("guestMsgSendBtn");
    const msgInput = document.getElementById("guestMsgInput");
    const msgEmail = document.getElementById("guestMsgEmail");
    const msgStatus = document.getElementById("guestMsgStatus");
    const msgThread = document.getElementById("guestMsgThread");
    let guestMsgPollTimer = null;
    let guestMsgLastId = 0;

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderGuestMessages(messages) {
      if (!msgThread) return;
      if (!messages.length) {
        msgThread.innerHTML = '<div class="small text-muted">Start a conversation with admin.</div>';
        return;
      }
      msgThread.innerHTML = messages.map(function (m) {
        const bubbleClass = m.from_admin ? "bot" : "me";
        const stamp = m.timestamp ? '<div class="small text-muted mt-1">' + escapeHtml(m.timestamp) + '</div>' : "";
        return '<div class="guest-bubble ' + bubbleClass + '">' + escapeHtml(m.content) + stamp + '</div>';
      }).join("");
      msgThread.scrollTop = msgThread.scrollHeight;
      const last = messages[messages.length - 1];
      guestMsgLastId = Math.max(guestMsgLastId, Number(last.id || 0));
    }

    async function refreshGuestMessages() {
      if (!msgThread) return;
      try {
        const res = await fetch("{{ url_for('main.guest_chat_messages') }}", { cache: "no-store" });
        const data = await res.json();
        if (res.ok && data.ok) {
          renderGuestMessages(data.messages || []);
        }
      } catch (_err) {
        // Keep silent; polling should not interrupt the page.
      }
    }

    if (sendBtn && msgInput && msgStatus) {
      sendBtn.addEventListener("click", async function () {
        const message = msgInput.value.trim();
        const email = msgEmail ? msgEmail.value.trim() : "";
        if (!message) {
          msgStatus.textContent = "Message cannot be empty.";
          return;
        }
        msgStatus.textContent = "Sending...";
        try {
          const res = await fetch("{{ url_for('main.guest_chat_send') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, message })
          });
          const data = await res.json();
          if (!res.ok || !data.ok) {
            msgStatus.textContent = data.error || "Failed to send.";
            return;
          }
          msgInput.value = "";
          msgStatus.textContent = data.message || "Message sent.";
          await refreshGuestMessages();
        } catch (_err) {
          msgStatus.textContent = "Network error. Try again.";
        }
      });
    }

    if (msgFab && msgPanel) {
      msgFab.addEventListener("click", function () {
        if (!msgPanel.classList.contains("d-none")) {
          refreshGuestMessages();
          if (!guestMsgPollTimer) {
            guestMsgPollTimer = setInterval(refreshGuestMessages, 5000);
          }
        } else if (guestMsgPollTimer) {
          clearInterval(guestMsgPollTimer);
          guestMsgPollTimer = null;
        }
      });
    }

    const guestToast = document.getElementById("guestWelcomeToast");
    if (guestToast && !sessionStorage.getItem("guest_welcome_seen")) {
      const toast = new bootstrap.Toast(guestToast, { delay: 9000 });
      toast.show();
      sessionStorage.setItem("guest_welcome_seen", "1");
    }

  })();
</script>
{% endblock %}
