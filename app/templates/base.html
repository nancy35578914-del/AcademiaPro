<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}AcademicPro{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body data-authenticated="{{ 'true' if current_user.is_authenticated else 'false' }}">
  <a class="skip-link" href="#main-content">Skip to content</a>

  <nav class="navbar navbar-expand-lg site-nav sticky-top" aria-label="Main navigation">
    <div class="container">
      <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="{{ url_for('main.index') }}">
        <img src="{{ url_for('static', filename='img/logo-quill.jpg') }}" alt="AcademicPro Logo" class="logo-circle">
        <span>
          AcademicPro
          <small class="d-block nav-tagline">Your Partner in Academic Excellence</small>
        </span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.services_page') }}">Services</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.public_writers') }}">Writers</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.Samples') }}">Samples</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.public_blogs') }}">Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.contact') }}">Contact</a></li>
        </ul>

        <div class="d-flex align-items-center gap-2 ms-lg-3">
          {% if current_user.is_authenticated and writer_enabled and not current_user.is_admin %}
            <span class="badge text-bg-info">Writer Mode</span>
          {% endif %}
          {% if current_user.is_authenticated %}
            {% if current_user.is_admin %}
              <a class="btn btn-warning btn-sm fw-semibold" href="{{ url_for('main.admin_dashboard') }}">Admin Panel</a>
            {% elif writer_enabled %}
              <a class="btn btn-warning btn-sm fw-semibold" href="{{ url_for('main.jobs') }}">Open Jobs</a>
            {% else %}
              <a class="btn btn-warning btn-sm fw-semibold" href="{{ url_for('main.order') }}">Place Order</a>
            {% endif %}
          {% else %}
            <a class="btn btn-warning btn-sm fw-semibold" href="{{ url_for('main.order') }}">Place Order</a>
          {% endif %}
          <button id="themeToggle" class="btn btn-sm theme-toggle-btn" type="button" aria-label="Switch to dark theme" title="Switch theme">
            <i class="bi bi-sun-fill" aria-hidden="true"></i>
            <span class="theme-toggle-text">Light</span>
          </button>
          {% if current_user.is_authenticated %}
            <a class="btn btn-sm nav-control-btn position-relative icon-btn" href="{{ url_for('main.notifications') }}" aria-label="Notifications">🔔{% if unread_count and unread_count > 0 %}<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ unread_count }}</span>{% endif %}</a>
          {% else %}
            <a class="btn btn-sm nav-control-btn icon-btn" href="{{ url_for('main.login') }}" aria-label="Notifications">🔔</a>
          {% endif %}
          {% if current_user.is_authenticated %}
            <div class="dropdown">
              <button class="btn btn-sm nav-control-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                {% if current_user.photo %}
                  <img src="{{ url_for('static', filename='uploads/' ~ current_user.photo) }}" alt="Profile" style="width:20px; height:20px; border-radius:50%; object-fit:cover; margin-right:6px;">
                {% else %}
                  <i class="bi bi-person-circle me-1" aria-hidden="true"></i>
                {% endif %}
                {{ current_user.name or 'Profile' }}
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                {% if current_user.is_admin %}
                <li><a class="dropdown-item" href="{{ url_for('main.admin_dashboard') }}">Admin Dashboard</a></li>
                <li><a class="dropdown-item" href="{{ url_for('main.admin_blog_manage') }}">Manage Blogs</a></li>
                <li><a class="dropdown-item" href="{{ url_for('main.admin_samples') }}">Manage Samples</a></li>
                {% elif writer_enabled %}
                <li><a class="dropdown-item" href="{{ url_for('main.dashboard') }}">Writer Dashboard</a></li>
                <li><a class="dropdown-item" href="{{ url_for('main.writer_blog_manage') }}">Manage Blogs</a></li>
                <li><a class="dropdown-item" href="{{ url_for('main.writer_samples') }}">Writer Samples</a></li>
                {% else %}
                <li><a class="dropdown-item" href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                {% endif %}
                <li><a class="dropdown-item" href="{{ url_for('main.settings') }}">Settings</a></li>
                <li><a class="dropdown-item" href="{{ url_for('main.support_tickets') }}">Help</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('main.logout') }}">Logout</a></li>
              </ul>
            </div>
          {% else %}
            <a class="btn btn-sm nav-control-btn" href="{{ url_for('main.login') }}">Sign In</a>
            <a class="btn btn-warning btn-sm fw-semibold" href="{{ url_for('main.register') }}">Sign Up</a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>

  <main id="main-content" class="container my-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category == 'message' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <div class="ai-float-shell" aria-label="AI support tools">
    <button id="globalAiFab" class="ai-fab" type="button" title="AI Support" aria-label="Open AI support">
      <img src="{{ url_for('static', filename='img/logo-quill.jpg') }}" alt="AcademicPro AI" class="ai-fab-logo">
    </button>
  </div>

  <div id="globalAiPanel" class="ai-panel d-none" role="dialog" aria-label="AcademicPro AI Support">
    <div class="ai-panel-head">
      <div>
        <div class="ai-title">AcademicPro AI</div>
        <div class="ai-sub">Smart assistant for orders, pricing, writers, and deadlines</div>
      </div>
      <button type="button" class="btn-close btn-close-sm" id="globalAiClose" aria-label="Close"></button>
    </div>
    <div id="globalAiBody" class="ai-panel-body"></div>
    <div class="ai-panel-foot">
      <textarea id="globalAiInput" class="form-control ai-input" rows="1" placeholder="Type your message..."></textarea>
      <button id="globalAiSend" class="btn btn-primary btn-sm ai-send-btn" type="button">Send</button>
    </div>
  </div>

  <footer id="contact" class="site-footer py-4 mt-5">
    <div class="container">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small fw-semibold mb-1">Quick Links</div>
          <div class="small d-flex flex-wrap gap-2">
            <a href="{{ url_for('main.index') }}">Home</a> |
            <a href="{{ url_for('main.public_blogs') }}">Blog</a> |
            <a href="{{ url_for('main.contact') }}">Contact</a> |
            <a href="{{ url_for('main.terms') }}">Terms</a> |
            <a href="{{ url_for('main.privacy_policy') }}">Privacy Policy</a>
          </div>
        </div>
        <div class="col-md-3 small">
          <div>Email: <a href="mailto:bwamistevenez001@gmail.com">bwamistevenez001@gmail.com</a></div>
          <div class="d-flex gap-3 align-items-center mt-1">
            <a href="#" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
            <a href="#" aria-label="Twitter"><i class="bi bi-twitter-x"></i></a>
            <a href="#" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
            <a href="#" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
            <a href="#" aria-label="TikTok"><i class="bi bi-tiktok"></i></a>
          </div>
        </div>
        <div class="col-md-3 small text-md-end">© 2026 AcademicPro - All Rights Reserved</div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      if (document.body.dataset.authenticated !== 'true') return;
      document.querySelectorAll("a[href*='/register']").forEach(function (el) { el.remove(); });
      document.querySelectorAll("a[href*='/signup']").forEach(function (el) { el.remove(); });
    })();

    (function () {
      const root = document.documentElement;
      const toggle = document.getElementById('themeToggle');
      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initial = stored || (prefersDark ? 'dark' : 'light');
      root.setAttribute('data-theme', initial);
      function setThemeToggleState(theme) {
        if (!toggle) return;
        const isDark = theme === 'dark';
        toggle.innerHTML = isDark
          ? '<i class="bi bi-moon-stars-fill" aria-hidden="true"></i><span class="theme-toggle-text">Dark</span>'
          : '<i class="bi bi-sun-fill" aria-hidden="true"></i><span class="theme-toggle-text">Light</span>';
        toggle.setAttribute('aria-label', isDark ? 'Switch to light theme' : 'Switch to dark theme');
        toggle.setAttribute('title', isDark ? 'Switch to light theme' : 'Switch to dark theme');
      }
      setThemeToggleState(initial);
      if (toggle) {
        toggle.addEventListener('click', function () {
          const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
          root.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
          setThemeToggleState(next);
        });
      }
    })();

    (function () {
      const fab = document.getElementById("globalAiFab");
      const panel = document.getElementById("globalAiPanel");
      const closeBtn = document.getElementById("globalAiClose");
      const body = document.getElementById("globalAiBody");
      const input = document.getElementById("globalAiInput");
      const send = document.getElementById("globalAiSend");

      if (!fab || !panel || !body || !input || !send) return;

      let pollHandle = null;

      function esc(v) {
        return String(v || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function autoGrow() {
        input.style.height = "auto";
        const next = Math.min(input.scrollHeight, 160);
        input.style.height = `${next}px`;
      }

      function bubble(role, text, timestamp) {
        const mine = role === "user";
        const align = mine ? "ai-msg me" : "ai-msg bot";
        const ts = timestamp ? `<div class="ai-ts">${esc(timestamp)}</div>` : "";
        return `<div class="${align}"><div class="ai-bubble">${esc(text)}</div>${ts}</div>`;
      }

      async function loadHistory() {
        try {
          const res = await fetch("{{ url_for('main.ai_chat_history') }}", { cache: "no-store" });
          const data = await res.json();
          if (!res.ok || !data.ok) return;
          const rows = data.messages || [];
          if (!rows.length) {
            body.innerHTML = bubble("assistant", "I am ready. Tell me your topic, deadline, level, and word count, and I will guide you step by step.");
            return;
          }
          body.innerHTML = rows.map((m) => bubble(m.role, m.content, m.timestamp)).join("");
          body.scrollTop = body.scrollHeight;
        } catch (_err) {}
      }

      async function sendMessage() {
        const message = input.value.trim();
        if (!message) return;
        input.value = "";
        autoGrow();
        try {
          const res = await fetch("{{ url_for('main.ai_chat_send') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
          });
          const data = await res.json();
          if (!res.ok || !data.ok) return;
          await loadHistory();
        } catch (_err) {}
      }

      function openPanel() {
        panel.classList.remove("d-none");
        loadHistory();
        if (!pollHandle) pollHandle = setInterval(loadHistory, 6000);
      }

      function closePanel() {
        panel.classList.add("d-none");
        if (pollHandle) {
          clearInterval(pollHandle);
          pollHandle = null;
        }
      }

      fab.addEventListener("click", () => {
        if (panel.classList.contains("d-none")) {
          openPanel();
        } else {
          closePanel();
        }
      });
      closeBtn.addEventListener("click", closePanel);
      send.addEventListener("click", sendMessage);
      input.addEventListener("input", autoGrow);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      autoGrow();
    })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
