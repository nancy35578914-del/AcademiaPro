{% extends "base.html" %}
{% block title %}Dashboard | AcademicPro{% endblock %}
{% block content %}
<div class="dashboard-wrap">
  {% set compact = (current_user.layout_mode == 'compact') %}
  {% if writer_enabled %}
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h2 class="mb-1">Writer Dashboard <span class="badge text-bg-info align-middle">Writer Mode</span></h2>
      <p class="text-muted mb-0">Decision-ready view to reduce admin time and maximize writing time.</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.jobs') }}" class="btn btn-primary btn-sm">Marketplace</a>
      <a href="{{ url_for('main.settings') }}" class="btn btn-outline-secondary btn-sm">Settings</a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-8">
      <div class="section-card">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div class="text-muted small">Performance Summary</div>
            <div class="kpi-big">${{ pending_payout }}</div>
            <div class="text-muted small">Pending payout balance</div>
          </div>
          <div class="kpi-grid">
            <div class="kpi-mini">
              <div class="kpi-mini-value">{{ active_writer_orders|length }}</div>
              <div class="kpi-mini-label">Active</div>
            </div>
            <div class="kpi-mini">
              <div class="kpi-mini-value">{{ revision_writer_orders|length }}</div>
              <div class="kpi-mini-label">Revisions</div>
            </div>
            <div class="kpi-mini">
              <div class="kpi-mini-value">{{ completed_writer_orders|length }}</div>
              <div class="kpi-mini-label">Completed</div>
            </div>
            <div class="kpi-mini">
              <div class="kpi-mini-value">${{ total_earnings }}</div>
              <div class="kpi-mini-label">Lifetime</div>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <div class="small text-muted mb-1">Workload completion</div>
          <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: {{ writer_workload_percent }}%;" aria-valuenow="{{ writer_workload_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="small text-muted mt-1">{{ writer_workload_percent }}% of assigned work completed</div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="section-card h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Up Next</h6>
          <span class="pill">Closest deadline</span>
        </div>
        {% if writer_next_order %}
          <div class="fw-semibold">#{{ writer_next_order.id }} {{ writer_next_order.topic }}</div>
          <div class="small text-muted">Due {{ writer_next_order.deadline.strftime('%Y-%m-%d') if writer_next_order.deadline else 'N/A' }}</div>
          <div class="small text-muted mt-1">Time remaining: <span class="time-remaining" data-deadline="{{ writer_next_order.deadline.isoformat() if writer_next_order.deadline else '' }}">--</span></div>
          <a href="{{ url_for('main.order_chat', order_id=writer_next_order.id) }}" class="btn btn-outline-primary btn-sm mt-2">Resume Writing</a>
        {% else %}
          <div class="text-muted small">No active orders yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="writer-tabs mb-3">
    <button class="tab-btn active" data-tab="marketplace">Marketplace</button>
    <button class="tab-btn" data-tab="production">Production</button>
    <button class="tab-btn" data-tab="finances">Finances</button>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-8">
      <div class="tab-panel active" data-panel="marketplace">
        <div class="section-card mb-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0">Marketplace</h5>
            <input id="marketSearch" class="form-control form-control-sm w-auto" placeholder="Search jobs by topic">
          </div>
          <div class="small text-muted mt-2 mb-2">Announcements to all writers</div>
          {% if writer_announcements %}
          <ul class="list-group list-group-flush mb-3">
            {% for a in writer_announcements[:4] %}
            <li class="list-group-item px-0">
              <div class="fw-semibold small">{{ a.title }}</div>
              <div class="small text-muted">{{ a.body }}</div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted small mb-3">No writer announcements yet.</div>
          {% endif %}

          <div class="small text-muted mb-2">Available to claim</div>
          {% if available_orders %}
          <div class="table-responsive">
            <table class="table table-sm align-middle" id="marketTable">
              <thead><tr><th>Topic</th><th>Deadline</th><th>Action</th></tr></thead>
              <tbody>
                {% for order in available_orders %}
                <tr data-topic="{{ order.topic|lower }}">
                  <td>{{ order.topic }}</td>
                  <td>{{ order.deadline.strftime('%Y-%m-%d') if order.deadline else 'N/A' }}</td>
                  <td><a href="{{ url_for('main.jobs') }}" class="btn btn-outline-primary btn-sm">Claim / Bid</a></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-muted small">No open orders right now.</div>
          {% endif %}
        </div>
      </div>

      <div class="tab-panel" data-panel="production">
        <div class="section-card mb-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0">Active Workspace</h5>
            <input id="activeSearch" class="form-control form-control-sm w-auto" placeholder="Search active orders">
          </div>
          <div class="small text-muted mt-2 mb-2">Assigned & in progress</div>
          {% if active_writer_orders %}
          <div class="d-flex flex-column gap-2" id="activeList">
            {% for order in active_writer_orders %}
            <div class="border rounded p-2 d-flex justify-content-between align-items-center" data-topic="{{ order.topic|lower }}">
              <div>
                <strong>#{{ order.id }} {{ order.topic }}</strong>
                <div class="small text-muted">Status: {{ order.status }} | Deadline: {{ order.deadline.strftime('%Y-%m-%d') if order.deadline else 'N/A' }}</div>
              </div>
              <a href="{{ url_for('main.order_chat', order_id=order.id) }}" class="btn btn-sm btn-primary">Resume Writing</a>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-muted small">No active assigned orders yet.</div>
          {% endif %}
        </div>

        {% if not compact %}
        <div class="section-card">
          <h5 class="mb-3">Communication Hub</h5>
          <div class="small text-muted mb-2">Messages & announcements</div>
          {% if recent_notifications %}
          <ul class="list-group list-group-flush">
            {% for n in recent_notifications %}
            <li class="list-group-item px-0">
              <div class="small">{{ n.content }}</div>
              <div class="small text-muted">{{ n.timestamp.strftime('%Y-%m-%d %H:%M') if n.timestamp else '' }}</div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted small">No new notifications.</div>
          {% endif %}
          <a href="{{ url_for('main.notifications') }}" class="btn btn-outline-secondary btn-sm mt-2">Open Notifications</a>
          {% if support_chat_enabled %}
          <hr>
          <div class="small text-muted mb-2">Live Chat with Admin</div>
          <div id="supportChatLog" class="border rounded p-2 mb-2 bg-light" style="height: 180px; overflow-y: auto;"></div>
          <div class="input-group input-group-sm">
            <input id="supportChatInput" class="form-control" placeholder="Type message to admin">
            <button id="supportChatSend" class="btn btn-primary" type="button">Send</button>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>

      <div class="tab-panel" data-panel="finances">
        <div class="section-card">
          <h5 class="mb-3">Earnings & Payments</h5>
          <div class="small mb-1">Total earnings: <strong>${{ total_earnings }}</strong></div>
          <div class="small mb-1">Pending payouts: <strong>${{ pending_payout }}</strong></div>
          <div class="small mb-1">On-time bonus: <strong>${{ on_time_bonus }}</strong></div>
          <div class="small mb-2">High-rating bonus: <strong>${{ high_rating_bonus }}</strong></div>
          <button class="btn btn-primary btn-sm w-100 mb-2" disabled>Request Payout (Coming Soon)</button>
          <div class="small text-muted">Supports PayPal, bank transfer, and mobile money in next phase.</div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      {% if not compact %}
      <div class="section-card mb-3">
        <h5 class="mb-3">Profile Management</h5>
        <div class="small mb-1"><strong>Name:</strong> {{ current_user.name }}</div>
        <div class="small mb-1"><strong>Expertise:</strong> {{ writer_subject }}</div>
        <div class="small mb-2"><strong>Bio:</strong> {{ writer_bio }}</div>
        <a href="{{ url_for('main.profile') }}" class="btn btn-outline-primary btn-sm w-100 mb-2">Edit Profile</a>
        <a href="{{ url_for('main.writer_samples') }}" class="btn btn-outline-secondary btn-sm w-100 mb-2">Upload Samples</a>
        <a href="{{ url_for('main.writer_blog_manage') }}" class="btn btn-outline-dark btn-sm w-100">Manage Blog Posts</a>
      </div>

      <div class="section-card mb-3">
        <h5 class="mb-3">Quick Tools</h5>
        <div class="d-grid gap-2">
          <a class="btn btn-outline-dark btn-sm" href="https://www.grammarly.com/plagiarism-checker" target="_blank" rel="noopener">Plagiarism Checker</a>
          <a class="btn btn-outline-dark btn-sm" href="https://app.grammarly.com/" target="_blank" rel="noopener">Grammar Checker</a>
          <a class="btn btn-outline-dark btn-sm" href="https://www.mybib.com/" target="_blank" rel="noopener">Citation Generator</a>
          <a class="btn btn-outline-dark btn-sm" href="https://owl.purdue.edu/owl/research_and_citation/resources.html" target="_blank" rel="noopener">Style Guide Library</a>
        </div>
      </div>
      {% endif %}

      <div class="section-card">
        <h5 class="mb-3">Settings & Security</h5>
        <a href="{{ url_for('main.settings') }}" class="btn btn-outline-primary btn-sm w-100 mb-2">Password & Notification Settings</a>
        <button class="btn btn-outline-secondary btn-sm w-100" disabled>Enable Two-Factor Authentication (Coming Soon)</button>
      </div>
    </div>
  </div>

  {% else %}
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h2 class="mb-1">Client Dashboard</h2>
      <p class="text-muted mb-0">Track orders, messages, payments, and account security from one place.</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.order') }}" class="btn btn-warning btn-sm fw-semibold">Place Order</a>
      <a href="{{ url_for('main.profile') }}" class="btn btn-outline-primary btn-sm">Profile</a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-xl-3">
      <a href="{{ url_for('main.my_orders') }}" class="dash-card-link text-decoration-none">
        <div class="tile-soft dash-stat-card">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="metric-value">{{ client_active_orders|length }}</div>
              <div class="metric-label">Active Orders</div>
            </div>
            <i class="bi bi-journal-check fs-4 text-primary"></i>
          </div>
        </div>
      </a>
    </div>
    <div class="col-sm-6 col-xl-3">
      <a href="{{ url_for('main.my_orders') }}" class="dash-card-link text-decoration-none">
        <div class="tile-soft dash-stat-card">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="metric-value">{{ client_completed_orders|length }}</div>
              <div class="metric-label">Completed Orders</div>
            </div>
            <i class="bi bi-check2-circle fs-4 text-success"></i>
          </div>
        </div>
      </a>
    </div>
    <div class="col-sm-6 col-xl-3">
      <a href="{{ url_for('main.my_orders') }}" class="dash-card-link text-decoration-none">
        <div class="tile-soft dash-stat-card">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="metric-value">{{ client_revision_orders|length }}</div>
              <div class="metric-label">Pending Revisions</div>
            </div>
            <i class="bi bi-arrow-repeat fs-4 text-warning"></i>
          </div>
        </div>
      </a>
    </div>
    <div class="col-sm-6 col-xl-3">
      <a href="{{ url_for('main.notifications') }}" class="dash-card-link text-decoration-none">
        <div class="tile-soft dash-stat-card">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="metric-value">{{ unread_count }}</div>
              <div class="metric-label">Notifications</div>
            </div>
            <i class="bi bi-bell fs-4 text-danger"></i>
          </div>
        </div>
      </a>
    </div>
  </div>

  <div class="section-card mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0">Overview / Order Status</h5>
      <a href="{{ url_for('main.my_orders') }}" class="btn btn-outline-primary btn-sm">Open Order List</a>
    </div>
    {% if client_primary_order %}
    <div class="row g-3 mt-1">
      <div class="col-lg-6">
        <div class="small text-muted">Current Focus Order</div>
        <div class="fw-semibold">#{{ client_primary_order.id }} {{ client_primary_order.topic }}</div>
        <div class="small text-muted">Deadline: {{ client_primary_order.deadline.strftime('%Y-%m-%d %H:%M') if client_primary_order.deadline else 'N/A' }}</div>
        <div class="small text-muted mt-1">Countdown: <span class="time-remaining" data-deadline="{{ client_primary_order.deadline.isoformat() if client_primary_order.deadline else '' }}">--</span></div>
      </div>
      <div class="col-lg-6">
        <div class="small text-muted mb-1">Completion Progress</div>
        <div class="progress" style="height: 8px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: {{ client_primary_progress }}%;" aria-valuenow="{{ client_primary_progress }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="small text-muted mt-1">{{ client_primary_progress }}% complete</div>
      </div>
    </div>
    {% else %}
    <div class="text-muted small mt-2">No active orders yet.</div>
    {% endif %}
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="section-card">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <h5 class="mb-0">Order Management</h5>
          <a href="{{ url_for('main.order') }}" class="btn btn-primary btn-sm">New Order</a>
        </div>
        {% if my_orders %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Title</th>
                <th>Deadline</th>
                <th>Status</th>
                <th>Assigned Writer</th>
                <th>Quick Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for order in my_orders %}
              {% set w = assigned_writer_map.get(order.id) %}
              {% set order_status = (order.status or '')|lower %}
              <tr>
                <td class="fw-semibold">#{{ order.id }}</td>
                <td>{{ order.topic }}</td>
                <td>
                  <div class="small">{{ order.deadline.strftime('%Y-%m-%d %H:%M') if order.deadline else 'N/A' }}</div>
                  <div class="small text-muted">Remaining: <span class="time-remaining" data-deadline="{{ order.deadline.isoformat() if order.deadline else '' }}">--</span></div>
                </td>
                <td><span class="badge bg-light text-dark">{{ order.status }}</span></td>
                <td>
                  {% if w %}
                    {{ w.name }}
                  {% else %}
                    <span class="text-muted">Pending assignment</span>
                  {% endif %}
                </td>
                <td class="d-flex flex-column gap-1">
                  <a href="{{ url_for('main.order_chat', order_id=order.id) }}" class="btn btn-outline-secondary btn-sm">Request Revision</a>
                  <a href="{{ url_for('main.order_chat', order_id=order.id) }}" class="btn btn-outline-success btn-sm {% if order_status != 'completed' %}disabled{% endif %}">Approve Draft</a>
                  <a href="{{ url_for('main.order_chat', order_id=order.id) }}#files" class="btn btn-outline-primary btn-sm">Download Paper</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <p class="text-muted mb-2">No orders yet - Place your first order today!</p>
          <a href="{{ url_for('main.order') }}" class="btn btn-warning btn-sm fw-semibold">Place Order</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-xl-8">
      <div class="section-card">
        <h5 class="mb-3">Communication Hub</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-muted mb-2">System Alerts</div>
            {% if client_order_updates %}
            <div class="d-flex flex-column gap-2">
              {% for n in client_order_updates %}
              {% set tone = 'alert-success' if 'completed' in (n.content or '')|lower else ('alert-danger' if 'urgent' in (n.content or '')|lower else 'alert-warning') %}
              <div class="alert {{ tone }} py-2 px-3 mb-0">
                <div class="small fw-semibold">{{ n.content }}</div>
                <div class="small">{{ n.timestamp.strftime('%Y-%m-%d %H:%M') if n.timestamp else '' }}</div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-muted small">No system alerts yet.</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <div class="small text-muted mb-2">Direct Messages</div>
            {% if client_direct_messages %}
            <div class="d-flex flex-column gap-2">
              {% for n in client_direct_messages %}
              <div class="border rounded p-2">
                <div class="small">{{ n.content }}</div>
                <div class="small text-muted">{{ n.timestamp.strftime('%Y-%m-%d %H:%M') if n.timestamp else '' }}</div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-muted small">No direct messages yet.</div>
            {% endif %}
          </div>
        </div>

        <hr>
        <div class="small text-muted mb-2">Order Notifications Tracker</div>
        <div class="d-flex flex-column gap-2">
          {% for order in my_orders[:4] %}
          {% set status_value = (order.status or '')|lower %}
          <div class="border rounded p-2">
            <div class="small fw-semibold mb-1">Order #{{ order.id }} - {{ order.topic }}</div>
            <div class="timeline">
              <span class="step {% if status_value in ['pending', 'open', 'in progress', 'revision', 'completed'] %}done{% endif %}">Submitted</span>
              <span class="step {% if status_value in ['in progress', 'revision', 'completed'] %}done{% elif status_value == 'open' %}active{% endif %}">In Progress</span>
              <span class="step {% if status_value in ['revision', 'completed'] %}done{% elif status_value == 'in progress' %}active{% endif %}">Draft</span>
              <span class="step {% if status_value == 'revision' %}active{% elif status_value == 'completed' %}done{% endif %}">Revision</span>
              <span class="step {% if status_value == 'completed' %}done{% endif %}">Completed</span>
            </div>
          </div>
          {% else %}
          <div class="text-muted small">No tracked orders yet.</div>
          {% endfor %}
        </div>

        <hr>
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <div class="small text-muted mb-0">Live Chat with Admin</div>
          <span class="badge {% if admin_availability == 'Online' %}bg-success{% else %}bg-secondary{% endif %}">{{ admin_availability }}</span>
        </div>
        <div id="supportChatLog" class="border rounded p-2 mb-2 bg-light" style="height: 200px; overflow-y: auto;"></div>
        <div class="input-group input-group-sm mb-2">
          <input id="supportChatInput" class="form-control" placeholder="Type message to admin" {% if admin_availability != 'Online' %}disabled{% endif %}>
          <button id="supportChatSend" class="btn btn-primary" type="button" {% if admin_availability != 'Online' %}disabled{% endif %}>Send</button>
        </div>
        <div class="input-group input-group-sm">
          <input id="supportChatFile" type="file" class="form-control" {% if admin_availability != 'Online' %}disabled{% endif %}>
          <button id="supportChatAttach" class="btn btn-outline-secondary" type="button" {% if admin_availability != 'Online' %}disabled{% endif %}>Attach</button>
        </div>
      </div>
    </div>

    <div class="col-xl-4">
      <div class="section-card mb-3">
        <h5 class="mb-3">Payment & Billing</h5>
        <div class="small mb-1">Current Balance: <strong>${{ current_balance }}</strong></div>
        <div class="small mb-2">Refunded Amount: <strong>${{ refunded_amount }}</strong></div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-outline-dark btn-sm">Payment Methods</button>
          <button class="btn btn-outline-secondary btn-sm">Download Invoice</button>
          <a href="{{ url_for('main.my_orders') }}" class="btn btn-outline-primary btn-sm">Order History</a>
        </div>
        <div class="small text-muted mb-2">Transaction Timeline</div>
        <div class="d-flex flex-column gap-2">
          {% for p in client_payments[:5] %}
          <div class="border rounded p-2">
            <div class="small fw-semibold">${{ p.amount or 0 }} - {{ p.status }}</div>
            <div class="small text-muted">{{ p.method or 'N/A' }} | {{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '' }}</div>
          </div>
          {% else %}
          <div class="text-muted small">No transactions yet.</div>
          {% endfor %}
        </div>
      </div>

      <div class="section-card mb-3">
        <h5 class="mb-3">Profile Management</h5>
        <div class="small mb-1"><strong>Name:</strong> {{ current_user.name }}</div>
        <div class="small mb-1"><strong>Email:</strong> {{ current_user.email }}</div>
        <div class="small mb-1"><strong>Academic Level:</strong> {{ current_user.academic_level or 'Not set' }}</div>
        <div class="small mb-2"><strong>Open Tickets:</strong> {{ open_tickets }}</div>
        <div class="small text-muted mb-2">Ticket Status</div>
        <div class="timeline mb-2">
          <span class="step">Open: {{ ticket_status_counts.get('open', 0) }}</span>
          <span class="step">Resolved: {{ ticket_status_counts.get('resolved', 0) }}</span>
          <span class="step">Closed: {{ ticket_status_counts.get('closed', 0) }}</span>
        </div>
        <a href="{{ url_for('main.profile') }}" class="btn btn-outline-primary btn-sm w-100">Edit Profile</a>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-xl-7">
      <div class="section-card h-100">
        <h5 class="mb-3">Resources & Extras</h5>
        <div class="small text-muted mb-2">Samples Library</div>
        <div class="row g-2 mb-3">
          {% for sample in featured_samples %}
          <div class="col-md-6">
            <a href="{{ url_for('main.sample_detail', sample_id=sample.id) }}" class="dash-card-link text-decoration-none">
              <div class="border rounded p-2 h-100">
                <div class="small fw-semibold">{{ sample.title }}</div>
                <div class="small text-muted">{{ sample.subject or 'General' }} | {{ sample.level or 'All levels' }}</div>
              </div>
            </a>
          </div>
          {% else %}
          <div class="col-12"><div class="text-muted small">No samples available right now.</div></div>
          {% endfor %}
        </div>

        <div class="small text-muted mb-2">Blog Highlights</div>
        <div class="row g-2 mb-3">
          {% for post in featured_blogs %}
          <div class="col-md-6">
            <a href="{{ url_for('main.blog_detail', id=post.id) }}" class="dash-card-link text-decoration-none">
              <div class="border rounded p-2 h-100">
                <div class="resource-thumb mb-2"><i class="bi bi-journal-richtext"></i></div>
                <div class="small fw-semibold">{{ post.title }}</div>
              </div>
            </a>
          </div>
          {% else %}
          <div class="col-12"><div class="text-muted small">No featured articles yet.</div></div>
          {% endfor %}
        </div>

        <div class="referral-card">
          <div class="fw-semibold mb-1">Referral Program</div>
          <div class="small text-muted mb-2">Share your link and earn credits on referred orders.</div>
          <div class="input-group input-group-sm mb-2">
            <input id="referralLinkInput" class="form-control" value="{{ referral_link }}" readonly>
            <button id="copyReferralBtn" class="btn btn-primary" type="button">Copy</button>
          </div>
          <a href="{{ url_for('main.register') }}" class="btn btn-outline-primary btn-sm w-100">Open Referral Signup</a>
        </div>
      </div>
    </div>
    <div class="col-xl-5">
      <div class="section-card h-100">
        <h5 class="mb-3">Settings & Security</h5>
        <a href="{{ url_for('main.settings') }}" class="btn btn-outline-primary btn-sm w-100 mb-2">Password & Preferences</a>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="twoFactorToggle" {% if current_user.two_factor_enabled %}checked{% endif %} disabled>
          <label class="form-check-label small" for="twoFactorToggle">Two-Factor Authentication</label>
        </div>
        <div class="small text-muted mb-3">Enable or disable 2FA from account settings.</div>

        <div class="small text-muted mb-2">Privacy Controls</div>
        <div class="d-grid gap-2">
          <a href="{{ url_for('main.support_tickets') }}" class="btn btn-outline-secondary btn-sm">Download Personal Data (GDPR)</a>
          <a href="{{ url_for('main.support_tickets') }}" class="btn btn-outline-danger btn-sm">Delete Personal Data Request</a>
        </div>
      </div>
    </div>
  </div>

  {% endif %}
</div>

<script>
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");
  tabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      tabButtons.forEach((b) => b.classList.remove("active"));
      tabPanels.forEach((p) => p.classList.remove("active"));
      btn.classList.add("active");
      const panel = document.querySelector(`[data-panel='${btn.dataset.tab}']`);
      if (panel) panel.classList.add("active");
    });
  });

  const marketSearch = document.getElementById("marketSearch");
  const marketTable = document.getElementById("marketTable");
  if (marketSearch && marketTable) {
    marketSearch.addEventListener("input", () => {
      const q = marketSearch.value.trim().toLowerCase();
      marketTable.querySelectorAll("tbody tr").forEach((row) => {
        const topic = row.dataset.topic || "";
        row.style.display = topic.includes(q) ? "" : "none";
      });
    });
  }

  const activeSearch = document.getElementById("activeSearch");
  const activeList = document.getElementById("activeList");
  if (activeSearch && activeList) {
    activeSearch.addEventListener("input", () => {
      const q = activeSearch.value.trim().toLowerCase();
      activeList.querySelectorAll("[data-topic]").forEach((row) => {
        const topic = row.dataset.topic || "";
        row.style.display = topic.includes(q) ? "" : "none";
      });
    });
  }

  function updateRemaining() {
    document.querySelectorAll(".time-remaining").forEach((el) => {
      const deadline = el.dataset.deadline;
      if (!deadline) {
        el.textContent = "N/A";
        return;
      }
      const end = new Date(deadline);
      const now = new Date();
      const diff = end - now;
      if (diff <= 0) {
        el.textContent = "Past due";
        return;
      }
      const hrs = Math.floor(diff / 3600000);
      const mins = Math.floor((diff % 3600000) / 60000);
      el.textContent = `${hrs}h ${mins}m`;
    });
  }
  updateRemaining();
  setInterval(updateRemaining, 60000);

  const supportLog = document.getElementById("supportChatLog");
  const supportInput = document.getElementById("supportChatInput");
  const supportSend = document.getElementById("supportChatSend");
  const supportFile = document.getElementById("supportChatFile");
  const supportAttach = document.getElementById("supportChatAttach");
  const referralInput = document.getElementById("referralLinkInput");
  const copyReferralBtn = document.getElementById("copyReferralBtn");
  let supportPoll = null;
  function esc(v) {
    return String(v || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
  async function refreshSupportChat() {
    if (!supportLog) return;
    try {
      const res = await fetch("{{ url_for('main.support_chat_messages') }}", { cache: "no-store" });
      const data = await res.json();
      if (!res.ok || !data.ok) return;
      const rows = data.messages || [];
      if (!rows.length) {
        supportLog.innerHTML = '<div class="small text-muted">No messages yet.</div>';
        return;
      }
      supportLog.innerHTML = rows.map((m) => {
        const align = m.from_admin ? "text-start" : "text-end";
        const cls = m.from_admin ? "bg-secondary" : "bg-primary";
        const textPart = m.content ? `<span class="badge ${cls} p-2">${esc(m.content)}</span>` : "";
        const files = (m.attachments || []).map((a) => {
          const href = String(a.url || "#");
          return `<div><a class="small" href="${href}" target="_blank" rel="noopener">${esc(a.filename)}</a></div>`;
        }).join("");
        return `<div class="mb-1 ${align}">${textPart}${files}<div class="small text-muted">${esc(m.timestamp)}</div></div>`;
      }).join("");
      supportLog.scrollTop = supportLog.scrollHeight;
    } catch (_e) {}
  }
  async function sendSupportMessage() {
    if (!supportInput || !supportInput.value.trim()) return;
    const message = supportInput.value.trim();
    supportInput.value = "";
    try {
      const res = await fetch("{{ url_for('main.support_chat_send') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) return;
      refreshSupportChat();
    } catch (_e) {}
  }
  async function attachSupportFileName() {
    if (!supportFile || !supportInput || !supportSend) return;
    if (!supportFile.files || !supportFile.files.length) return;
    const selected = supportFile.files[0];
    const form = new FormData();
    form.append("file", selected);
    try {
      supportAttach.disabled = true;
      const res = await fetch("{{ url_for('main.support_chat_upload') }}", {
        method: "POST",
        body: form
      });
      const data = await res.json();
      if (!res.ok || !data.ok) return;
      const marker = `[SupportAttachment:${data.filename}]`;
      supportInput.value = supportInput.value.trim() ? `${supportInput.value.trim()} ${marker}` : marker;
      await sendSupportMessage();
      supportFile.value = "";
    } catch (_e) {
    } finally {
      supportAttach.disabled = false;
    }
  }
  if (supportLog) {
    refreshSupportChat();
    supportPoll = setInterval(refreshSupportChat, 5000);
  }
  if (supportSend) {
    supportSend.addEventListener("click", sendSupportMessage);
  }
  if (supportInput) {
    supportInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendSupportMessage();
      }
    });
  }
  if (supportAttach) {
    supportAttach.addEventListener("click", attachSupportFileName);
  }
  if (copyReferralBtn && referralInput) {
    copyReferralBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(referralInput.value);
        copyReferralBtn.textContent = "Copied";
        setTimeout(() => { copyReferralBtn.textContent = "Copy"; }, 1200);
      } catch (_e) {}
    });
  }
</script>
{% endblock %}
